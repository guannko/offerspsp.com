name: SUPER SYSTEM Autosave

on:
  # Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ð¾ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸ÑŽ
  schedule:
    - cron: '*/30 * * * *'  # ÐšÐ°Ð¶Ð´Ñ‹Ðµ 30 Ð¼Ð¸Ð½ÑƒÑ‚
    - cron: '0 0 * * *'     # ÐŸÐ¾Ð»Ð½Ð¾Ñ‡ÑŒ Ð´Ð»Ñ cleanup
  
  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº
  workflow_dispatch:
    inputs:
      save_type:
        description: 'Ð¢Ð¸Ð¿ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ'
        required: true
        default: 'checkpoint'
        type: choice
        options:
          - quick
          - checkpoint
          - emergency
          - cleanup

  # ÐŸÑ€Ð¸ push Ð² main (emergency save)
  push:
    branches: [main]
    paths:
      - '**.md'
      - '**.json'
      - 'Annoris/**'
      - 'offerspsp-mvp/**'

jobs:
  autosave:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: ðŸ“Š Check current state
        run: |
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ..."
          if [ -f "health-check.js" ]; then
            node health-check.js || true
          fi
      
      - name: ðŸ’¾ Run Autosave
        run: |
          # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ‚Ð¸Ð¿ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SAVE_TYPE="${{ github.event.inputs.save_type }}"
          elif [ "${{ github.event_name }}" = "push" ]; then
            SAVE_TYPE="emergency"
          elif [ "$(date +%H:%M)" = "00:00" ]; then
            SAVE_TYPE="cleanup"
          else
            SAVE_TYPE="checkpoint"
          fi
          
          echo "ðŸ”„ Ð—Ð°Ð¿ÑƒÑÐº autosave: $SAVE_TYPE"
          node autosave.js $SAVE_TYPE
      
      - name: ðŸ“ˆ Update metrics
        run: |
          echo "ðŸ“Š ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¼ÐµÑ‚Ñ€Ð¸Ðº..."
          node autosave.js stats
      
      - name: ðŸ“ Commit changes
        run: |
          git config --local user.email "autosave@superystem.ai"
          git config --local user.name "SUPER SYSTEM Bot"
          
          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
          git add .autosave/ CURRENT-STATE.md || true
          git add Annoris/.sync-state.json || true
          git add offerspsp-mvp/.sync-state.json || true
          
          # ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¸Ð¼ ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "ðŸ”„ Autosave: $(date +'%Y-%m-%d %H:%M') UTC
            
            Save type: ${{ github.event_name }}
            Triggered by: ${{ github.actor }}
            " || true
            
            git push || true
          else
            echo "âœ… ÐÐµÑ‚ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð´Ð»Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ"
          fi
      
      - name: ðŸ”„ Sync hemispheres
        run: |
          echo "ðŸ§  Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ð¾Ð»ÑƒÑˆÐ°Ñ€Ð¸Ð¹..."
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð¿Ð¾Ð»ÑƒÑˆÐ°Ñ€Ð¸Ð¹
          if [ -f "Annoris/hemisphere-status.json" ]; then
            echo "Left hemisphere: $(cat Annoris/hemisphere-status.json | grep status)"
          fi
          
          if [ -f "offerspsp-mvp/hemisphere-status.json" ]; then
            echo "Right hemisphere: $(cat offerspsp-mvp/hemisphere-status.json | grep status)"
          fi
      
      - name: ðŸ“Š Generate report
        if: success()
        run: |
          echo "## ðŸ“Š Autosave Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date +'%Y-%m-%d %H:%M:%S') UTC" >> $GITHUB_STEP_SUMMARY
          echo "- **Type:** $SAVE_TYPE" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f ".autosave/current.json" ]; then
            echo "### System State:" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat .autosave/current.json | head -20 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  # ÐžÑ‚Ð´ÐµÐ»ÑŒÐ½Ð°Ñ job Ð´Ð»Ñ cleanup (Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ñ€Ð°Ð· Ð² Ð´ÐµÐ½ÑŒ)
  cleanup:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 0 * * *'
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v3
      
      - name: ðŸ§¹ Run cleanup
        run: |
          echo "ðŸ§¹ Ð—Ð°Ð¿ÑƒÑÐº Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸ ÑÑ‚Ð°Ñ€Ñ‹Ñ… autosave..."
          node autosave.js cleanup
          
          # Ð¢Ð°ÐºÐ¶Ðµ Ñ‡Ð¸ÑÑ‚Ð¸Ð¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ autosave Ð² Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸ÑÑ…
          find . -name "*autosave*" -type f -mtime +30 -delete || true
          echo "âœ… ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°"
      
      - name: ðŸ“ Commit cleanup
        run: |
          git config --local user.email "autosave@supersystem.ai"
          git config --local user.name "SUPER SYSTEM Bot"
          
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "ðŸ§¹ Cleanup: Removed old autosave files (>30 days)"
            git push
          fi